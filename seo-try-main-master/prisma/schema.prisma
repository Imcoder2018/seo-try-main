generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  clerkUserId      String            @unique // Clerk user ID for authentication
  email            String            @unique
  name             String?
  password         String?           // Hashed password for email/password auth (deprecated, kept for migration)
  plan             Plan              @default(FREE)
  role             UserRole          @default(CLIENT)
  audits           Audit[]
  sessions         Session[]
  scheduledContent ScheduledContent[]
  contentAnalyses  ContentAnalysis[]
  crawlRequests    CrawlRequest[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([clerkUserId])
}

enum UserRole {
  CLIENT
  AGENCY_ADMIN
  AGENCY_MEMBER
  ADMIN
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([userId])
}

enum Plan {
  FREE
  PRO
  AGENCY
  WHITE_LABEL
}

model Audit {
  id               String      @id @default(cuid())
  url              String
  domain           String
  status           AuditStatus @default(PENDING)
  overallScore     Int?
  overallGrade     String?

  localSeoScore    Int?
  seoScore         Int?
  linksScore       Int?
  usabilityScore   Int?
  performanceScore Int?
  socialScore      Int?
  contentScore     Int?
  eeatScore        Int?
  accessibilityScore Int?

  localSeoResults  Json?
  seoResults         Json?
  linksResults       Json?
  usabilityResults   Json?
  performanceResults Json?
  socialResults      Json?
  technologyResults  Json?
  contentResults     Json?
  eeatResults        Json?
  accessibilityResults Json?

  recommendations Recommendation[]

  desktopScreenshot String?
  mobileScreenshot  String?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggerId   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([domain])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model DomainHistory {
  id        String   @id @default(cuid())
  domain    String
  date      DateTime @default(now())
  
  overallScore     Int
  localSeoScore    Int?
  seoScore         Int?
  linksScore       Int?
  usabilityScore   Int?
  performanceScore Int?
  socialScore      Int?
  contentScore     Int?
  eeatScore        Int?
  accessibilityScore Int?

  // Core Web Vitals
  lcp       Float?
  fid       Float?
  cls       Float?
  fcp       Float?
  ttfb      Float?

  userId    String?
  
  createdAt DateTime @default(now())

  @@index([domain])
  @@index([domain, date])
  @@index([userId])
}

enum AuditStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model Recommendation {
  id          String   @id @default(cuid())
  auditId     String
  audit       Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)
  title       String
  description String?
  category    String
  priority    Priority
  checkId     String

  @@index([auditId])
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

model CachedResult {
  id        String   @id @default(cuid())
  domain    String   @unique
  data      Json
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([domain])
  @@index([expiresAt])
}

// ==================== CONTENT SCHEDULING MODELS ====================

model WordPressSite {
  id            String   @id @default(cuid())
  userId        String
  name          String
  siteUrl       String
  apiKey        String   // SEO AutoFix plugin API key
  wpUsername    String?
  wpAppPassword String?  // WordPress application password for REST API
  isActive      Boolean  @default(true)
  
  scheduledContent ScheduledContent[]
  keywords         Keyword[]
  contentPlans     ContentPlan[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, siteUrl])
  @@index([userId])
}

model Keyword {
  id            String   @id @default(cuid())
  wordpressSiteId String
  wordpressSite WordPressSite @relation(fields: [wordpressSiteId], references: [id], onDelete: Cascade)
  
  keyword       String
  searchVolume  Int?
  difficulty    Int?      // 1-100
  cpc           Float?
  intent        String?   // informational, transactional, navigational, commercial
  location      String?   // Target location for local SEO
  isGenerated   Boolean   @default(false) // AI generated or manually added
  
  scheduledContent ScheduledContent[]
  
  createdAt     DateTime @default(now())

  @@unique([wordpressSiteId, keyword])
  @@index([wordpressSiteId])
}

model ContentPlan {
  id              String   @id @default(cuid())
  wordpressSiteId String
  wordpressSite   WordPressSite @relation(fields: [wordpressSiteId], references: [id], onDelete: Cascade)
  
  name            String
  month           Int      // 1-12
  year            Int
  postsPerWeek    Int      @default(3)
  contentTypes    String[] // blog, service-page, location-page, faq
  targetKeywords  String[] // Keywords to focus on this month
  
  scheduledContent ScheduledContent[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([wordpressSiteId])
  @@index([month, year])
}

model ScheduledContent {
  id              String   @id @default(cuid())
  wordpressSiteId String
  wordpressSite   WordPressSite @relation(fields: [wordpressSiteId], references: [id], onDelete: Cascade)

  contentPlanId   String?
  contentPlan     ContentPlan? @relation(fields: [contentPlanId], references: [id], onDelete: SetNull)

  keywordId       String?
  keyword         Keyword? @relation(fields: [keywordId], references: [id], onDelete: SetNull)

  userId          String   // Link to user for ownership tracking (required)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content details
  title           String
  slug            String?
  content         String   @db.Text
  excerpt         String?
  metaDescription String?
  focusKeyword    String
  secondaryKeywords String[]

  // Outline structure (JSON for AI-generated outline)
  outline         Json?    // Stores the H2 structure for article generation

  // Featured image
  featuredImageUrl String?
  featuredImageAlt String?
  isAiGeneratedImage Boolean @default(false)

  // Post settings
  postType        String   @default("post") // post, page
  postStatus      String   @default("draft") // draft, publish, scheduled
  categories      String[]
  tags            String[]

  // Scheduling
  scheduledFor    DateTime
  timezone        String   @default("UTC")

  // Publishing status
  status          ContentStatus @default(PENDING)
  approvalStatus  ApprovalStatus @default(PENDING)
  wpPostId        Int?     // WordPress post ID after publishing
  publishedAt     DateTime?
  publishError    String?

  // SEO metrics (from AI analysis)
  seoScore        Int?
  readabilityScore Int?
  contentLength   Int?

  // Target service for internal linking
  targetService   String?
  targetServiceUrl String?

  // Smart Context fields for unified workflow
  sourceSuggestionId String?  // To track which AI suggestion spawned this
  analysisRunId      String?  // Link back to the analysis report
  tone               String?  // Content tone (professional, casual, etc.)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([wordpressSiteId])
  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([contentPlanId])
  @@index([sourceSuggestionId])
  @@index([analysisRunId])
}

enum ContentStatus {
  PENDING       // Content created, waiting for scheduled time
  GENERATING    // AI is generating content
  READY         // Ready to be published
  PUBLISHING    // Currently being published
  PUBLISHED     // Successfully published to WordPress
  FAILED        // Failed to publish
  CANCELLED     // Cancelled by user
}

enum ApprovalStatus {
  PENDING    // Content created, waiting for review
  APPROVED   // Approved for publishing
  REJECTED   // Rejected, needs revision
}

model ContentAnalysis {
  id          String   @id @default(cuid())
  baseUrl     String
  domain      String
  status      AnalysisStatus @default(PENDING)
  
  // Analysis results (optional - populated when analysis completes)
  dominantKeywords Json?
  contentGaps      Json?
  audiencePersona  String?
  tone             String?
  aiSuggestions    Json?
  pagesAnalyzed    Int?
  
  // Output data
  analysisOutput   Json?
  
  // Link to crawl request that triggered this analysis
  crawlRequestId  String?
  crawlRequest    CrawlRequest? @relation(fields: [crawlRequestId], references: [id], onDelete: SetNull)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  @@index([domain])
  @@index([userId])
  @@index([status])
  @@index([crawlRequestId])
}

// Crawl Request History - tracks all crawling requests
model CrawlRequest {
  id          String   @id @default(cuid())
  url         String
  domain      String
  maxPages    Int
  status      CrawlStatus @default(PENDING)
  
  // Trigger.dev integration
  triggerRunId String?  // The run ID from Trigger.dev
  publicToken  String?  // Public token for status polling
  
  // Results
  pagesFound  Int?
  pagesData   Json?    // Store the crawled pages data
  crawlData   Json?    // Store the full crawl output
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relations
  contentAnalyses ContentAnalysis[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  @@index([domain])
  @@index([userId])
  @@index([status])
  @@index([triggerRunId])
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum AnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}
